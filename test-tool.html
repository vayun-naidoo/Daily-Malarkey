<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Layering Test Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #333; color: white; display: flex; gap: 20px; padding: 20px; }
        
        /* CONTROLS (Left) */
        #controls { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        input, button { padding: 10px; border-radius: 4px; border: none; }
        button { cursor: pointer; font-weight: bold; background: #eee; color: #333; }
        button:hover { background: #fff; }
        label { font-size: 12px; font-weight: bold; color: #aaa; margin-bottom: 5px; display: block;}

        /* PREVIEW (Right) */
        #canvas-container { border: 2px solid #555; height: 675px; /* Half size preview */ }
        canvas { height: 100%; width: auto; display: block; background: #000; }
    </style>
</head>
<body>

    <div id="controls">
        <h2>Layering Test</h2>
        
        <div>
            <label>1. User Overlay Image (1080x843)</label>
            <input type="file" id="userImgInput" accept="image/*">
        </div>

        <div>
            <label>2. Text Overlay</label>
            <input type="text" id="userText" placeholder="Enter headline..." value="TEST HEADLINE">
        </div>

        <div>
            <label>3. Vertical Position of User Image (Y-Axis)</label>
            <input type="range" id="imgY" min="0" max="1350" value="250">
        </div>

        <button onclick="drawCanvas()">Update Preview</button>
        <button onclick="downloadCanvas()" style="background: #4CAF50; color: white;">Download Image</button>
    </div>

    <div id="canvas-container">
        <canvas id="previewCanvas" width="1080" height="1350"></canvas>
    </div>

<script>
    // CONFIGURATION
    const ASSET_TEMPLATE_PATH = "assets/red_3.png"; 
    
    // VARIABLES
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    
    let templateImg = new Image();
    let userImg = new Image();
    let assetsLoaded = false;

    // 1. INITIALIZE
    // Load the base template immediately on startup
    window.onload = function() {
        templateImg.src = ASSET_TEMPLATE_PATH;
        templateImg.onload = () => {
            assetsLoaded = true;
            drawCanvas(); // Draw background immediately
        };
        templateImg.onerror = () => alert("Error: assets/template.png not found!");
    };

    // 2. HANDLE USER IMAGE UPLOAD
    document.getElementById('userImgInput').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            userImg = new Image();
            userImg.onload = drawCanvas; // Redraw when loaded
            userImg.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // 3. HANDLE SLIDER & TEXT UPDATES
    document.getElementById('imgY').oninput = drawCanvas;
    document.getElementById('userText').oninput = drawCanvas;

    // 4. THE COMPOSITING LOGIC
    function drawCanvas() {
        // A. Clear Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // B. Draw Base Template (Bottom Layer)
        if (assetsLoaded) {
            ctx.drawImage(templateImg, 0, 0, 1080, 1350);
        }

        // C. Draw User Image (Middle Layer)
        // Only draw if user has uploaded something
        if (userImg.src) {
            const yPos = parseInt(document.getElementById('imgY').value);
            // Draw image at 1080 width, maintaining aspect ratio or forcing height
            // Here we force the requested 1080x843 for consistency
            ctx.drawImage(userImg, 0, yPos, 1080, 843);
        }

        // D. Draw Text (Top Layer)
        const text = document.getElementById('userText').value;
        if (text) {
            ctx.fillStyle = "white"; // Text Color
            ctx.font = "bold 80px Georgia"; // Font Style
            ctx.textAlign = "center";
            ctx.shadowColor = "rgba(0,0,0,0.8)"; // Drop shadow for readability
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 4;
            ctx.shadowOffsetY = 4;
            
            // Position text (e.g., near bottom)
            ctx.fillText(text, canvas.width / 2, 1200);
        }
    }

    // 5. DOWNLOAD
    function downloadCanvas() {
        canvas.toBlob(function(blob) {
            saveAs(blob, "composited_image.png");
        });
    }
</script>
</body>
</html>