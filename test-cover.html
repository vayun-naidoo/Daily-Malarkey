<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Template Wrapper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #333; color: white; display: flex; gap: 20px; padding: 20px; }
        
        #controls { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        input, button, textarea, select { padding: 10px; border-radius: 4px; border: none; width: 100%; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; }
        button { cursor: pointer; font-weight: bold; background: #eee; color: #333; margin-top: 10px;}
        button:hover { background: #fff; }
        label { font-size: 12px; font-weight: bold; color: #aaa; margin-bottom: 5px; display: block;}
        
        .input-row { display: flex; gap: 10px; align-items: center; }
        input[type="range"] { flex: 1; cursor: pointer; }
        input[type="number"] { width: 70px; text-align: center; } 
        input[type="checkbox"] { width: auto; }

        details { background: #444; padding: 10px; border-radius: 4px; }
        summary { cursor: pointer; font-weight: bold; font-size: 14px; margin-bottom: 5px; color: #ddd; }

        #canvas-container { border: 2px solid #555; height: 675px; }
        canvas { height: 100%; width: auto; display: block; background: #000; }
    </style>
</head>
<body>

    <div id="controls">
        <h2>Template Builder</h2>
        
        <div>
            <label>1. Select Template</label>
            <select id="templateSelect" onchange="changeTemplate()">
                <option value="red_3.png">Red Theme (3 Dots)</option>
                <option value="red_4.png">Red Theme (4 Dots)</option>
                <option value="white_3.png">White Theme (3 Dots)</option>
                <option value="white_4.png">White Theme (4 Dots)</option>
            </select>
        </div>

        <div>
            <label>2. Overlay Image</label>
            <input type="file" id="userImgInput" accept="image/*">
        </div>

        <div>
            <label>3. Text Content</label>
            <textarea id="userText" placeholder="Type here...">This is a sample sentence to test the dynamic color switching based on your template selection.</textarea>
        </div>

        <div>
            <label>Font Size (px)</label>
            <div class="input-row">
                <input type="range" id="fontSizeRange" min="20" max="120" value="60" oninput="syncFontSize('range')">
                <input type="number" id="fontSizeNum" min="20" max="120" value="60" oninput="syncFontSize('num')">
            </div>
        </div>

        <details>
            <summary>Advanced Tools</summary>
            
            <div style="margin-top: 10px;">
                <label>Line Height (Multiplier)</label>
                <input type="range" id="lineHeightMult" min="0.8" max="2.0" step="0.1" value="1.2">
            </div>

            <div class="row" style="margin-top: 10px;">
                <input type="checkbox" id="debugBox">
                <label for="debugBox" style="margin:0; color: white;">Show Debug Box</label>
            </div>
        </details>

        <button onclick="drawCanvas()">Update Preview</button>
        <button onclick="downloadCanvas()" style="background: #4CAF50; color: white;">Download Image</button>
    </div>

    <div id="canvas-container">
        <canvas id="previewCanvas" width="1080" height="1350"></canvas>
    </div>

<script>
    // COORDINATES (Same for all templates)
    const BOX_X = 33;
    const BOX_Y = 892;
    const BOX_W = 1047 - 33; 
    const BOX_H = 1231 - 892;

    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    
    let templateImg = new Image();
    let userImg = new Image();
    let assetsLoaded = false;

    // Initialize with default selection
    window.onload = function() {
        changeTemplate(); 
    };

    // --- CHANGE TEMPLATE FUNCTION ---
    function changeTemplate() {
        const selectedFile = document.getElementById('templateSelect').value;
        const path = "assets/" + selectedFile;
        
        assetsLoaded = false;
        templateImg = new Image();
        templateImg.src = path;
        
        templateImg.onload = () => {
            assetsLoaded = true;
            drawCanvas();
        };
        
        templateImg.onerror = () => {
            alert("Error: Could not load " + path);
        };
    }

    function syncFontSize(source) {
        const range = document.getElementById('fontSizeRange');
        const num = document.getElementById('fontSizeNum');
        if (source === 'range') num.value = range.value;
        else range.value = num.value;
        drawCanvas();
    }

    // Input Handlers
    document.getElementById('userImgInput').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            userImg = new Image();
            userImg.onload = drawCanvas;
            userImg.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('userText').oninput = drawCanvas;
    document.getElementById('lineHeightMult').oninput = drawCanvas;
    document.getElementById('debugBox').onchange = drawCanvas;

    function wrapText(context, text, x, y, maxWidth, maxHeight, lineHeight) {
        const paragraphs = text.split('\n');
        const centerX = x + (maxWidth / 2);
        let currentY = y; 

        for (let p = 0; p < paragraphs.length; p++) {
            const words = paragraphs[p].split(' ');
            let line = '';

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && n > 0) {
                    context.fillText(line, centerX, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                }
                else {
                    line = testLine;
                }
            }
            context.fillText(line, centerX, currentY);
            currentY += lineHeight;
        }
    }

    function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Draw Template
        if (assetsLoaded) {
            ctx.drawImage(templateImg, 0, 0, 1080, 1350);
        } else {
            ctx.fillStyle = "#333"; ctx.fillRect(0,0,1080,1350); 
        }

        // 2. Draw User Image
        if (userImg.src) {
            ctx.drawImage(userImg, 0, 0, 1080, 843);
        }

        // 3. Text Configuration (Auto-Color Logic)
        const fontSize = parseInt(document.getElementById('fontSizeNum').value);
        const multiplier = parseFloat(document.getElementById('lineHeightMult').value);
        const lineHeight = fontSize * multiplier;
        
        // --- COLOR LOGIC ---
        const currentTemplate = document.getElementById('templateSelect').value;
        if (currentTemplate.includes('red')) {
            ctx.fillStyle = "white"; 
        } else {
            ctx.fillStyle = "black"; 
        }

        ctx.font = `${fontSize}px Georgia`;
        ctx.textBaseline = 'top'; 
        ctx.textAlign = "center"; 

        const text = document.getElementById('userText').value;

        // 4. Debug Box
        if (document.getElementById('debugBox').checked) {
            ctx.strokeStyle = "green";
            ctx.lineWidth = 5;
            ctx.strokeRect(BOX_X, BOX_Y, BOX_W, BOX_H);
        }

        // 5. Execute Wrap
        wrapText(ctx, text, BOX_X, BOX_Y, BOX_W, BOX_H, lineHeight);
    }

    function downloadCanvas() {
        canvas.toBlob(function(blob) {
            saveAs(blob, "final_template.png");
        });
    }
</script>
</body>
</html>